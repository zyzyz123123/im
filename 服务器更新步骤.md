# æœåŠ¡å™¨æ›´æ–°æ“ä½œæ­¥éª¤

> ä½ çš„æœåŠ¡å™¨é¡¹ç›®ä½ç½®ï¼š`/opt`

## ğŸ¯ æ–¹æ¡ˆï¼šæœ¬åœ°æ‰“åŒ… + ä¸Šä¼ éƒ¨ç½²

å› ä¸ºæœåŠ¡å™¨æ— æ³• Git Pullï¼Œä½¿ç”¨æœ¬åœ°æ‰“åŒ…æ–¹å¼ã€‚

---

## ğŸ“¦ å®Œæ•´æ“ä½œæµç¨‹

### æ­¥éª¤ 1ï¼šæœ¬åœ°æ‰“åŒ…ï¼ˆåœ¨ä½ çš„ Mac ä¸Šï¼‰

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /Users/yuanzhizhang/IdeaProjects/im

# æ‰§è¡Œæœ¬åœ°æ„å»º
./deploy.sh local-build
```

æ‰§è¡Œåä¼šç”Ÿæˆï¼š
- `deploy/` ç›®å½•ï¼ˆåŒ…å«ç¼–è¯‘å¥½çš„æ–‡ä»¶ï¼‰
- `deploy.tar.gz` å‹ç¼©åŒ…ï¼ˆçº¦ 60-80MBï¼‰

---

### æ­¥éª¤ 2ï¼šä¸Šä¼ åˆ°æœåŠ¡å™¨

```bash
# ä¸Šä¼ å‹ç¼©åŒ…åˆ°æœåŠ¡å™¨ä¸´æ—¶ç›®å½•
scp deploy.tar.gz root@your-server-ip:/tmp/

# æˆ–è€…å¦‚æœé…ç½®äº† SSH åˆ«å
scp deploy.tar.gz your-server:/tmp/
```

---

### æ­¥éª¤ 3ï¼šæœåŠ¡å™¨ä¸Šéƒ¨ç½²

```bash
# SSH ç™»å½•æœåŠ¡å™¨
ssh root@your-server-ip

# è¿›å…¥é¡¹ç›®ç›®å½•
cd /opt/im

# å¤‡ä»½å½“å‰ç‰ˆæœ¬ï¼ˆé‡è¦ï¼ï¼‰
tar czf ../im-backup-$(date +%Y%m%d-%H%M%S).tar.gz .

# è§£å‹æ–°ç‰ˆæœ¬ï¼ˆä¿ç•™ .env ç­‰é…ç½®æ–‡ä»¶ï¼‰
tar xzf /tmp/deploy.tar.gz --strip-components=1

# å¦‚æœæ˜¯é¦–æ¬¡ä½¿ç”¨æ–°çš„éƒ¨ç½²æ–¹å¼ï¼Œç¡®ä¿è„šæœ¬æœ‰æ‰§è¡Œæƒé™
chmod +x deploy.sh

# æ›´æ–°éƒ¨ç½²
./deploy.sh update
```

---

## âš¡ ä¸€é”®æ“ä½œï¼ˆæ¨èï¼‰

### åˆ›å»ºæœ¬åœ°å¿«æ·è„šæœ¬

åœ¨ä½ çš„ Mac ä¸Šåˆ›å»ºä¸€ä¸ªå¿«é€Ÿéƒ¨ç½²è„šæœ¬ï¼š

```bash
# åœ¨æœ¬åœ°é¡¹ç›®æ ¹ç›®å½•åˆ›å»º
cat > quick-update.sh << 'EOF'
#!/bin/bash
set -e

# é…ç½®ä½ çš„æœåŠ¡å™¨ä¿¡æ¯
SERVER="root@your-server-ip"
REMOTE_PATH="/opt/im"

echo "========================================="
echo "  å¿«é€Ÿæ›´æ–°åˆ°æœåŠ¡å™¨"
echo "========================================="
echo ""

# 1. æœ¬åœ°æ„å»º
echo "ğŸ“¦ æœ¬åœ°æ„å»º..."
./deploy.sh local-build

# 2. ä¸Šä¼ 
echo "ğŸ“¤ ä¸Šä¼ åˆ°æœåŠ¡å™¨..."
scp deploy.tar.gz $SERVER:/tmp/

# 3. è¿œç¨‹éƒ¨ç½²
echo "ğŸš€ æœåŠ¡å™¨éƒ¨ç½²..."
ssh $SERVER << ENDSSH
cd $REMOTE_PATH
echo "å¤‡ä»½å½“å‰ç‰ˆæœ¬..."
tar czf ../im-backup-\$(date +%Y%m%d-%H%M%S).tar.gz . 2>/dev/null || true
echo "è§£å‹æ–°ç‰ˆæœ¬..."
tar xzf /tmp/deploy.tar.gz --strip-components=1
echo "æ›´æ–°éƒ¨ç½²..."
./deploy.sh update
echo "æŸ¥çœ‹çŠ¶æ€..."
docker compose ps
ENDSSH

echo ""
echo "âœ… éƒ¨ç½²å®Œæˆï¼"
echo ""
echo "æŸ¥çœ‹æ—¥å¿—: ssh $SERVER 'cd $REMOTE_PATH && docker compose logs -f backend'"
EOF

chmod +x quick-update.sh
```

ä¿®æ”¹è„šæœ¬ä¸­çš„æœåŠ¡å™¨ä¿¡æ¯ï¼š
```bash
vi quick-update.sh
# ä¿®æ”¹ SERVER="root@your-server-ip" ä¸ºä½ çš„å®é™…æœåŠ¡å™¨åœ°å€
```

ä»¥åæ¯æ¬¡æ›´æ–°åªéœ€è¦ï¼š
```bash
./quick-update.sh
```

---

## ğŸ”§ å…·ä½“ç¤ºä¾‹ï¼ˆå‡è®¾ä½ çš„æœåŠ¡å™¨ IP æ˜¯ 120.48.139.174ï¼‰

### é¦–æ¬¡é…ç½®

```bash
# åœ¨æœ¬åœ°
cd /Users/yuanzhizhang/IdeaProjects/im

# é…ç½®æœåŠ¡å™¨ä¿¡æ¯
export SERVER="root@120.48.139.174"

# æµ‹è¯•è¿æ¥
ssh $SERVER "ls -la /opt/im"
```

### æ›´æ–°æ“ä½œ

```bash
# 1. æœ¬åœ°æ„å»º
./deploy.sh local-build

# 2. ä¸Šä¼ 
scp deploy.tar.gz root@120.48.139.174:/tmp/

# 3. éƒ¨ç½²
ssh root@120.48.139.174 << 'EOF'
cd /opt/im
tar czf ../im-backup-$(date +%Y%m%d-%H%M%S).tar.gz .
tar xzf /tmp/deploy.tar.gz --strip-components=1
./deploy.sh update
EOF

# 4. æŸ¥çœ‹æ—¥å¿—
ssh root@120.48.139.174 "cd /opt/im && docker compose logs -f backend"
```

---

## ğŸ“‹ æ—¥å¸¸ç»´æŠ¤å‘½ä»¤

### åœ¨æœåŠ¡å™¨ä¸Šæ“ä½œ

```bash
# SSH ç™»å½•
ssh root@your-server-ip

# è¿›å…¥é¡¹ç›®ç›®å½•
cd /opt/im

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker compose ps

# æŸ¥çœ‹æ—¥å¿—
docker compose logs -f backend
docker compose logs -f frontend

# é‡å¯æœåŠ¡
docker compose restart backend
docker compose restart frontend

# æŸ¥çœ‹èµ„æºä½¿ç”¨
docker stats

# å¤‡ä»½æ•°æ®åº“
docker exec im-mysql mysqldump -uroot -p${MYSQL_ROOT_PASSWORD} im > backup_$(date +%Y%m%d).sql
```

### ä»æœ¬åœ°è¿œç¨‹æ“ä½œ

```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
ssh root@your-server-ip "cd /opt/im && docker compose ps"

# æŸ¥çœ‹æ—¥å¿—
ssh root@your-server-ip "cd /opt/im && docker compose logs --tail=100 backend"

# é‡å¯æœåŠ¡
ssh root@your-server-ip "cd /opt/im && docker compose restart backend"
```

---

## ğŸ› å¸¸è§é—®é¢˜

### 1. ä¸Šä¼ å¤±è´¥

```bash
# æ£€æŸ¥æœåŠ¡å™¨è¿æ¥
ssh root@your-server-ip "echo 'Connection OK'"

# æ£€æŸ¥ç£ç›˜ç©ºé—´
ssh root@your-server-ip "df -h"

# æ£€æŸ¥ /tmp ç›®å½•æƒé™
ssh root@your-server-ip "ls -ld /tmp"
```

### 2. éƒ¨ç½²å¤±è´¥

```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
ssh root@your-server-ip "cd /opt/im && docker compose logs backend"

# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸Šä¼ å®Œæ•´
ssh root@your-server-ip "ls -lh /tmp/deploy.tar.gz"

# é‡æ–°è§£å‹
ssh root@your-server-ip "cd /opt/im && tar xzf /tmp/deploy.tar.gz --strip-components=1 -v"
```

### 3. æœåŠ¡å¯åŠ¨å¤±è´¥

```bash
# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨çŠ¶æ€
ssh root@your-server-ip "cd /opt/im && docker compose ps -a"

# æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
ssh root@your-server-ip "cd /opt/im && docker compose logs"

# é‡æ–°æ„å»º
ssh root@your-server-ip "cd /opt/im && docker compose build --no-cache && docker compose up -d"
```

---

## ğŸ”„ å›æ»šæ“ä½œ

å¦‚æœæ–°ç‰ˆæœ¬æœ‰é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›æ»šï¼š

```bash
# åœ¨æœåŠ¡å™¨ä¸Š
cd /opt/im

# åœæ­¢å½“å‰æœåŠ¡
docker compose down

# æŸ¥æ‰¾å¤‡ä»½
ls -lht /opt/im-backup-*.tar.gz | head -1

# æ¢å¤å¤‡ä»½ï¼ˆæ›¿æ¢ä¸ºå®é™…çš„å¤‡ä»½æ–‡ä»¶åï¼‰
rm -rf /opt/im/*
tar xzf /opt/im-backup-20251104-153000.tar.gz -C /opt/im/

# é‡å¯æœåŠ¡
cd /opt/im
docker compose up -d
```

---

## ğŸ“Š æ›´æ–°æ£€æŸ¥æ¸…å•

æ¯æ¬¡æ›´æ–°åæ£€æŸ¥ï¼š

```bash
# 1. æœåŠ¡çŠ¶æ€éƒ½æ˜¯ Up
docker compose ps

# 2. å‰ç«¯å¯è®¿é—®
curl http://localhost

# 3. åç«¯è¿è¡Œæ­£å¸¸
docker compose logs backend | grep "Started ImApplication"

# 4. æ— é”™è¯¯æ—¥å¿—
docker compose logs backend | grep ERROR

# 5. æ•°æ®åº“è¿æ¥æ­£å¸¸
docker compose exec backend sh -c "curl -s http://localhost:8080/actuator/health"
```

---

## ğŸ’¡ ä¼˜åŒ–å»ºè®®

### 1. é…ç½® SSH å¯†é’¥ï¼ˆå…å¯†ç™»å½•ï¼‰

```bash
# åœ¨æœ¬åœ°ç”Ÿæˆå¯†é’¥ï¼ˆå¦‚æœæ²¡æœ‰ï¼‰
ssh-keygen -t rsa -b 4096

# å¤åˆ¶å…¬é’¥åˆ°æœåŠ¡å™¨
ssh-copy-id root@your-server-ip

# ä»¥åå°±å¯ä»¥å…å¯†ç™»å½•
ssh root@your-server-ip
```

### 2. é…ç½® SSH åˆ«å

åœ¨æœ¬åœ° `~/.ssh/config` æ·»åŠ ï¼š

```
Host im-server
    HostName your-server-ip
    User root
    Port 22
    IdentityFile ~/.ssh/id_rsa
```

ä»¥åå¯ä»¥ç®€å†™ï¼š
```bash
ssh im-server
scp deploy.tar.gz im-server:/tmp/
```

### 3. è®¾ç½®è‡ªåŠ¨æ¸…ç†

åœ¨æœåŠ¡å™¨ä¸Šè®¾ç½®å®šæ—¶æ¸…ç†æ—§å¤‡ä»½ï¼š

```bash
# æ·»åŠ åˆ° crontab
crontab -e

# æ¯å‘¨æ¸…ç† 30 å¤©å‰çš„å¤‡ä»½
0 2 * * 0 find /opt/im-backup-*.tar.gz -mtime +30 -delete
```

---

## ğŸ“ æ›´æ–°æ—¥å¿—æ¨¡æ¿

å»ºè®®æ¯æ¬¡æ›´æ–°è®°å½•ï¼š

```
æ›´æ–°æ—¥æœŸ: 2025-11-04
æ›´æ–°å†…å®¹: 
  - ä¿®å¤äº†èŠå¤©æ¶ˆæ¯æ˜¾ç¤ºé—®é¢˜
  - æ›´æ–°äº†ç”¨æˆ·æœåŠ¡æ¥å£
  
å¤‡ä»½æ–‡ä»¶: /opt/im-backup-20251104-153000.tar.gz
éƒ¨ç½²æ—¶é—´: 15:35
éªŒè¯ç»“æœ: âœ… æ­£å¸¸
```

---

**è®°ä½ï¼šæ¯æ¬¡æ›´æ–°å‰å…ˆå¤‡ä»½æ•°æ®åº“ï¼**

```bash
ssh root@your-server-ip "docker exec im-mysql mysqldump -uroot -p\${MYSQL_ROOT_PASSWORD} im > /backup/im_\$(date +%Y%m%d).sql"
```

